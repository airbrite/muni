<!DOCTYPE html>

<html>
<head>
  <title>mongo.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="adapter.html">
                adapter.js
              </a>
            
              
              <a class="source" href="collection.html">
                collection.js
              </a>
            
              
              <a class="source" href="controller.html">
                controller.js
              </a>
            
              
              <a class="source" href="crud_controller.html">
                crud_controller.js
              </a>
            
              
              <a class="source" href="database.html">
                database.js
              </a>
            
              
              <a class="source" href="docco.html">
                docco.js
              </a>
            
              
              <a class="source" href="error.html">
                error.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="job.html">
                job.js
              </a>
            
              
              <a class="source" href="model.html">
                model.js
              </a>
            
              
              <a class="source" href="mongo.html">
                mongo.js
              </a>
            
              
              <a class="source" href="queue.html">
                queue.js
              </a>
            
              
              <a class="source" href="renderer.html">
                renderer.js
              </a>
            
              
              <a class="source" href="router.html">
                router.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>mongo.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">"use strict"</span>;

<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>);
<span class="hljs-keyword">var</span> Promise = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>);
<span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter;
<span class="hljs-keyword">var</span> MongoClient = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>).MongoClient;
<span class="hljs-keyword">var</span> ObjectID = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>).ObjectID;

Promise.delay = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ms)</span> {</span>
  <span class="hljs-keyword">var</span> promise = <span class="hljs-keyword">new</span> Promise(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resolve, reject)</span> {</span>
    setTimeout(resolve, ms);
  });
  <span class="hljs-keyword">return</span> promise;
};

Promise.promisifyAll(MongoClient);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Takes url to a mongodb</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Mongo = module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(url, options)</span> {</span>
  <span class="hljs-keyword">this</span>.options = options || {};

  <span class="hljs-keyword">this</span>.client = MongoClient;
  <span class="hljs-keyword">this</span>.url = url || <span class="hljs-string">"mongodb://localhost:27017"</span>;
  <span class="hljs-keyword">this</span>._db = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">this</span>.connection = <span class="hljs-string">"disconnected"</span>;
  <span class="hljs-keyword">this</span>.reconnectTimeout = <span class="hljs-keyword">this</span>.options.reconnectTimeout || <span class="hljs-number">500</span>;
};

Mongo.prototype = <span class="hljs-built_in">Object</span>.create(EventEmitter.prototype);

_.extend(Mongo.prototype, {
  connect: Promise.method(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();

    <span class="hljs-keyword">return</span> Promise
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.connection === <span class="hljs-string">"connected"</span>) {
          callback &amp;&amp; callback(<span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>._db);
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._db;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.connection === <span class="hljs-string">"connecting"</span>) {
          <span class="hljs-keyword">return</span> Promise.delay(<span class="hljs-keyword">this</span>.reconnectTimeout)
            .bind(<span class="hljs-keyword">this</span>)
            .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connect(callback);
            });
        }

        <span class="hljs-keyword">this</span>.connection = <span class="hljs-string">"connecting"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.client.connectAsync(<span class="hljs-keyword">this</span>.url, <span class="hljs-keyword">this</span>.options)
          .bind(<span class="hljs-keyword">this</span>)
          .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(db)</span> {</span>
            <span class="hljs-keyword">this</span>._db = db;
            <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"connect"</span>, <span class="hljs-keyword">this</span>.url);
            <span class="hljs-keyword">this</span>.connection = <span class="hljs-string">"connected"</span>;
            callback &amp;&amp; callback(<span class="hljs-literal">null</span>, db);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._db;
          })
          .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
            <span class="hljs-keyword">this</span>.connection = <span class="hljs-string">"disconnected"</span>;
            callback &amp;&amp; callback(err);
            <span class="hljs-keyword">throw</span> err;
          });
      });
  }),

  collection: Promise.method(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connect()
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> collection = <span class="hljs-keyword">this</span>._db.collection(collectionName);
        Promise.promisifyAll(collection);
        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, collection);
        <span class="hljs-keyword">return</span> collection;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  }),

  isValidObjectID: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id)</span> {</span>
    <span class="hljs-keyword">var</span> checkForHexRegExp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">"^[0-9a-fA-F]{24}$"</span>);
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> id === <span class="hljs-string">'string'</span>) &amp;&amp; id.length === <span class="hljs-number">24</span> &amp;&amp; checkForHexRegExp.test(id);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Automatic casting to ObjectID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  cast: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> {</span>
    _.each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val, key)</span> {</span>
      <span class="hljs-keyword">if</span> (_.isString(val)) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isValidObjectID(val)) {
          obj[key] = <span class="hljs-keyword">new</span> ObjectID(val);
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.isObject(val)) {
        <span class="hljs-keyword">if</span> (val[<span class="hljs-string">'$oid'</span>]) {
          obj[key] = val[<span class="hljs-string">'$oid'</span>];
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cast(val);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span>;
      }
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> obj;
  },

  uncast: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> {</span>
    _.each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val, key)</span> {</span>
      <span class="hljs-keyword">if</span> (val &amp;&amp; _.isFunction(val.toHexString)) {
        obj[key] = val.toHexString();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.isObject(val)) {
        <span class="hljs-keyword">if</span> (val[<span class="hljs-string">'$oid'</span>]) {
          obj[key] = val[<span class="hljs-string">'$oid'</span>];
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.uncast(val);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span>;
      }
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> obj;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>generate a new object id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  newId: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ObjectID().toHexString();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>retrieve the cursor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _cursor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName, query)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> options = args.length &gt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span> &amp;&amp; args.pop();
    options = options || {};

    <span class="hljs-keyword">var</span> cursor;
    <span class="hljs-keyword">if</span> (options.fields) {
      <span class="hljs-keyword">var</span> fields = options.fields;
      <span class="hljs-keyword">delete</span> options.fields;
      cursor = <span class="hljs-keyword">this</span>._db.collection(collectionName).find(query, fields, options);
    } <span class="hljs-keyword">else</span> {
      cursor = <span class="hljs-keyword">this</span>._db.collection(collectionName).find(query, options);
    }

    Promise.promisifyAll(cursor);
    <span class="hljs-keyword">return</span> cursor;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Find with a cursor, can pass in options.fields and get specific fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  findCursor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName, query)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);

    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();
    <span class="hljs-keyword">var</span> options = ((args.length &gt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span>) &amp;&amp; args.pop());

    options = options || {};

    query = <span class="hljs-keyword">this</span>.cast(query);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connect()
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._cursor(collectionName, query, options);
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cursor)</span> {</span>
        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, cursor);
        <span class="hljs-keyword">return</span> cursor;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Count associated with findCursor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  count: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName, query)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();
    <span class="hljs-keyword">var</span> options = args.length &gt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span> &amp;&amp; args.pop();

    options = options || {};

    query = <span class="hljs-keyword">this</span>.cast(query);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.findCursor(collectionName, query, options)
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cursor)</span> {</span>
        <span class="hljs-keyword">return</span> cursor.countAsync();
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(count)</span> {</span>
        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, count);
        <span class="hljs-keyword">return</span> count;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Find all docs matching query and turn into an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  find: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName, query)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();
    <span class="hljs-keyword">var</span> options = args.length &gt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span> &amp;&amp; args.pop();

    options = options || {};

    query = <span class="hljs-keyword">this</span>.cast(query);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connect()
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._cursor(collectionName, query, options);
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cursor)</span> {</span>
        <span class="hljs-keyword">return</span> cursor.toArrayAsync();
      })
      .then(<span class="hljs-keyword">this</span>.uncast)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> {</span>
        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, obj);
        <span class="hljs-keyword">return</span> obj;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  },

  pagination: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName, query)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();
    <span class="hljs-keyword">var</span> options = args.length &gt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span> &amp;&amp; args.pop();

    options = options || {};

    query = <span class="hljs-keyword">this</span>.cast(query);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connect()
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.count(collectionName, query, options);
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(total)</span> {</span>
        <span class="hljs-keyword">var</span> count = ((options.limit) &amp;&amp; (options.limit &lt;= total)) ? options.limit : total;
        <span class="hljs-keyword">var</span> limit = options.limit || <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> skip = options.skip || <span class="hljs-number">0</span>;

        <span class="hljs-keyword">var</span> obj = {
          total: <span class="hljs-built_in">parseInt</span>(total),
          count: <span class="hljs-built_in">parseInt</span>(count),
          limit: <span class="hljs-built_in">parseInt</span>(limit),
          offset: <span class="hljs-built_in">parseInt</span>(skip),
          has_more: <span class="hljs-built_in">parseInt</span>(count) &lt; <span class="hljs-built_in">parseInt</span>(total)
        };

        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, obj);
        <span class="hljs-keyword">return</span> obj;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Find a single doc matching query</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  findOne: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName, query)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();
    <span class="hljs-keyword">var</span> options = args.length &gt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span> &amp;&amp; args.pop();

    options = options || {};

    query = <span class="hljs-keyword">this</span>.cast(query);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.collection(collectionName)
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection)</span> {</span>
        <span class="hljs-keyword">return</span> collection.findOneAsync(query, options);
      })
      .then(<span class="hljs-keyword">this</span>.uncast)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        <span class="hljs-keyword">if</span> (!data &amp;&amp; options.require) {
          <span class="hljs-keyword">var</span> requireErr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Document not found."</span>)
          <span class="hljs-keyword">throw</span> requireErr;
        }

        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, data);
        <span class="hljs-keyword">return</span> data;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Insert a document (safe: true)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  insert: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName, obj)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();
    <span class="hljs-keyword">var</span> options = args.length &gt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span> &amp;&amp; args.pop();

    obj = <span class="hljs-keyword">this</span>.cast(obj);
    options = _.extend({
      safe: <span class="hljs-literal">true</span>
    }, options || {}); <span class="hljs-comment">// force safe mode</span>

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.collection(collectionName)
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection)</span> {</span>
        <span class="hljs-keyword">return</span> collection.insertAsync(obj, options);
      })
      .then(<span class="hljs-keyword">this</span>.uncast)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, data);
        <span class="hljs-keyword">return</span> data;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Update one or more docs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  update: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName, query, obj)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();
    <span class="hljs-keyword">var</span> options = args.length &gt; <span class="hljs-number">3</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span> &amp;&amp; args.pop();

    query = <span class="hljs-keyword">this</span>.cast(query);
    obj = <span class="hljs-keyword">this</span>.cast(obj);
    options = _.extend({
      safe: <span class="hljs-literal">true</span>
    }, options || {}); <span class="hljs-comment">// force safe mode</span>

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.collection(collectionName)
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection)</span> {</span>
        <span class="hljs-keyword">return</span> collection.updateAsync(query, obj, options);
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, data);
        <span class="hljs-keyword">return</span> data;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Update and return one doc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  findAndModify: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName, query, obj)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();
    <span class="hljs-keyword">var</span> options = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span> &amp;&amp; args.pop();
    <span class="hljs-keyword">var</span> options = args.length &gt; <span class="hljs-number">3</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span> &amp;&amp; args.pop();

    query = <span class="hljs-keyword">this</span>.cast(query);
    obj = <span class="hljs-keyword">this</span>.cast(obj);
    options = _.extend({
      <span class="hljs-keyword">new</span>: <span class="hljs-literal">true</span>,
      safe: <span class="hljs-literal">true</span>
    }, options || {}); <span class="hljs-comment">// force new mode, safe mode</span>


    <span class="hljs-keyword">var</span> sort = options.sort || {};
    <span class="hljs-keyword">delete</span> options.sort;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.collection(collectionName)
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection)</span> {</span>
        <span class="hljs-keyword">return</span> collection.findAndModifyAsync(query, sort, obj, options);
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(response)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>mongodb gives the response as the object [0] and updateObject[1]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        response.pop(); <span class="hljs-comment">// pop off updateObject</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>it could also be a multiupdate — if it is, return response as array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (options.multi) {
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.uncast(response);
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>if not, what eves</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.uncast(response[<span class="hljs-number">0</span>]);
        }
      }).then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, data);
        <span class="hljs-keyword">return</span> data;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Remove a document and returns count</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  remove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName, query)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();
    <span class="hljs-keyword">var</span> options = args.length &gt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span> &amp;&amp; args.pop();

    query = <span class="hljs-keyword">this</span>.cast(query);
    options = _.extend({
      safe: <span class="hljs-literal">true</span>
    }, options || {}); <span class="hljs-comment">// force new mode, safe mode</span>

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.collection(collectionName)
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection)</span> {</span>
        <span class="hljs-keyword">return</span> collection.removeAsync(query, options);
      }).then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, data);
        <span class="hljs-keyword">return</span> data;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Aggregate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  aggregate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName, query)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();
    <span class="hljs-keyword">var</span> options = args.length &gt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span> &amp;&amp; args.pop();
    options = options || {};

    query = <span class="hljs-keyword">this</span>.cast(query);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.collection(collectionName)
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>weird bug if options is empty, and undefined doesn’t seem to work — seems to either be mongo-node or the promisify framework … 
since aggregate has a different set of options from everything else, it’s probably default objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!_.isEmpty(options)) {
          <span class="hljs-keyword">return</span> collection.aggregateAsync(query, options);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> collection.aggregateAsync(query);
        }
      })
      .then(<span class="hljs-keyword">this</span>.uncast)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, data);
        <span class="hljs-keyword">return</span> data;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Get next sequence for counter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getNextSequence: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName, query)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();
    <span class="hljs-keyword">var</span> options = args.length &gt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span> &amp;&amp; args.pop();

    query = <span class="hljs-keyword">this</span>.cast(query);
    options = _.extend({
      safe: <span class="hljs-literal">true</span>,
      <span class="hljs-keyword">new</span>: <span class="hljs-literal">true</span>
    }, options || {});

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.findAndModify(collectionName, query, {
        <span class="hljs-string">"$inc"</span>: {
          seq: <span class="hljs-number">1</span>
        }
      }, options)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> {</span>
        <span class="hljs-keyword">return</span> obj.seq;
      }).then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, data);
        <span class="hljs-keyword">return</span> data;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Erases all records from a collection, if any</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  eraseCollection: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.remove(collectionName, {})
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, data);
        <span class="hljs-keyword">return</span> data;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Indexes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ensureIndex: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName, index)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();
    <span class="hljs-keyword">var</span> options = args.length &gt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'object'</span> &amp;&amp; args.pop();
    options = options || {};

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.collection(collectionName)
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection)</span> {</span>
        collection.ensureIndexAsync(index, options);
      }).then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, data);
        <span class="hljs-keyword">return</span> data;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  },


  dropIndexes: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionName)</span> {</span>
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] == <span class="hljs-string">'function'</span> &amp;&amp; args.pop();

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.collection(collectionName)
      .bind(<span class="hljs-keyword">this</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection)</span> {</span>
        <span class="hljs-keyword">return</span> collection.dropIndexesAsync();
      }).then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        callback &amp;&amp; callback(<span class="hljs-literal">null</span>, data);
        <span class="hljs-keyword">return</span> data;
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        callback &amp;&amp; callback(err);
        <span class="hljs-keyword">throw</span> err;
      });
  }

});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
